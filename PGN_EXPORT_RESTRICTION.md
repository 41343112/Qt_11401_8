# PGN 匯出與複製功能限制

## 功能說明

根據需求，PGN 匯出和複製棋譜功能現在只在以下兩種模式下可用：

1. **一般模式**（無任何特殊遊戲模式）
2. **僅霧戰模式**（只啟用霧戰模式，沒有其他特殊模式）

其他任何特殊遊戲模式組合都不會顯示 PGN 匯出和複製按鈕。

## 影響的遊戲模式

### ✅ 會顯示 PGN 功能

- **一般模式**（本地遊玩、電腦對戰、線上對戰且無特殊模式）
- **僅霧戰模式**（線上對戰且只勾選霧戰模式）

### ❌ 不會顯示 PGN 功能

- 🌍 地吸引力模式
- 🔮 傳送陣模式
- 🎲 骰子模式
- 💣 踩地雷模式
- 🌫️ 霧戰 + 任何其他特殊模式的組合

## 技術實現

### 修改的文件

- `src/qt_chess.cpp`

### 修改的函數

#### 1. `onStartGameReceived()` (行 7054)

在遊戲開始時檢查遊戲模式，決定是否顯示棋譜列表和回放按鈕。

使用 `shouldShowPGNFeatures()` 輔助方法來判斷：

```cpp
// 檢查是否應該顯示棋譜記錄功能（詳見 shouldShowPGNFeatures() 方法）
if (shouldShowPGNFeatures()) {
    // 顯示棋譜相關元件（一般模式或僅霧戰模式）
    if (m_moveListTitle) m_moveListTitle->show();
    if (m_moveListWidget) m_moveListWidget->show();
} else {
    // 隱藏棋譜相關元件（其他特殊遊戲模式組合）
    // ...
}
```

#### 2. `handleGameEnd()` (行 4706)

在遊戲結束時檢查遊戲模式，決定是否顯示 PGN 匯出和複製按鈕。

使用相同的 `shouldShowPGNFeatures()` 輔助方法來判斷：

```cpp
// 顯示匯出 PGN 按鈕和複製棋譜按鈕（僅在一般模式或僅霧戰模式時）
if (shouldShowPGNFeatures()) {
    // 顯示 PGN 按鈕
    if (m_exportPGNButton) m_exportPGNButton->show();
    if (m_copyPGNButton) m_copyPGNButton->show();
} else {
    // 隱藏 PGN 按鈕
    // ...
}
```

#### 3. `shouldShowPGNFeatures()` (行 5117-5123)

輔助方法，集中管理 PGN 功能顯示邏輯：

```cpp
bool Qt_Chess::shouldShowPGNFeatures() const {
    // 檢查是否應該顯示 PGN 相關功能（匯出、複製、棋譜列表）
    // 只有一般模式（無任何特殊模式）或僅啟用霧戰模式（沒有其他特殊模式）時才顯示
    bool hasBombMode = m_selectedGameModes.contains(GAME_MODE_BOMB) && m_selectedGameModes[GAME_MODE_BOMB];
    bool hasOtherSpecialModes = m_gravityModeEnabled || m_teleportModeEnabled || 
                                 m_diceModeEnabled || hasBombMode;
    return !hasOtherSpecialModes;
}

## 邏輯驗證

| 霧戰 | 地吸引力 | 傳送陣 | 骰子 | 踩地雷 | 顯示 PGN |
|------|----------|--------|------|--------|----------|
| ❌   | ❌       | ❌     | ❌   | ❌     | ✅       |
| ✅   | ❌       | ❌     | ❌   | ❌     | ✅       |
| ❌   | ✅       | ❌     | ❌   | ❌     | ❌       |
| ✅   | ✅       | ❌     | ❌   | ❌     | ❌       |
| ❌   | ❌       | ✅     | ❌   | ❌     | ❌       |
| ❌   | ❌       | ❌     | ✅   | ❌     | ❌       |
| ❌   | ❌       | ❌     | ❌   | ✅     | ❌       |

## 測試建議

### 測試案例 1：本地遊玩（一般模式）

1. 啟動應用程式
2. 選擇「本地遊玩」
3. 開始遊戲並走幾步
4. 結束遊戲（將死或認輸）

**預期結果：** 
- 棋譜列表應顯示移動
- 應顯示「📤 匯出 PGN」按鈕
- 應顯示「📋 複製棋譜」按鈕

### 測試案例 2：電腦對戰（一般模式）

1. 啟動應用程式
2. 選擇「電腦對戰」
3. 選擇顏色並開始遊戲
4. 走幾步後結束遊戲

**預期結果：**
- 棋譜列表應顯示移動
- 應顯示「📤 匯出 PGN」按鈕
- 應顯示「📋 複製棋譜」按鈕

### 測試案例 3：線上對戰 - 僅霧戰模式

1. 啟動兩個應用程式實例
2. 實例 A：選擇「線上遊玩」→「創建房間」
3. 實例 A：在遊戲模式選擇對話框中，只勾選「🌫️ 霧戰」
4. 實例 A：開始並記下房間號碼
5. 實例 B：選擇「線上遊玩」→「加入房間」→輸入房號
6. 實例 A：按「開始」
7. 雙方走幾步後結束遊戲

**預期結果：**
- 雙方的棋譜列表應顯示移動
- 雙方應顯示「📤 匯出 PGN」按鈕
- 雙方應顯示「📋 複製棋譜」按鈕

### 測試案例 4：線上對戰 - 地吸引力模式

1. 重複測試案例 3 的步驟 1-2
2. 實例 A：在遊戲模式選擇對話框中，只勾選「🌍 地吸引力」
3. 繼續步驟 4-7

**預期結果：**
- 棋譜列表應該隱藏
- 不應顯示「📤 匯出 PGN」按鈕
- 不應顯示「📋 複製棋譜」按鈕

### 測試案例 5：線上對戰 - 霧戰 + 骰子模式

1. 重複測試案例 3 的步驟 1-2
2. 實例 A：在遊戲模式選擇對話框中，勾選「🌫️ 霧戰」和「🎲 骰子」
3. 繼續步驟 4-7

**預期結果：**
- 棋譜列表應該隱藏
- 不應顯示「📤 匯出 PGN」按鈕
- 不應顯示「📋 複製棋譜」按鈕

### 測試案例 6：線上對戰 - 一般模式（無特殊模式）

1. 重複測試案例 3 的步驟 1-2
2. 實例 A：在遊戲模式選擇對話框中，不勾選任何模式
3. 繼續步驟 4-7

**預期結果：**
- 雙方的棋譜列表應顯示移動
- 雙方應顯示「📤 匯出 PGN」按鈕
- 雙方應顯示「📋 複製棋譜」按鈕

## 兼容性

此更改僅影響 UI 顯示邏輯，不影響：
- 遊戲規則
- 網路通訊
- 儲存功能
- 其他現有功能

## 注意事項

1. **本地和電腦模式**：這些模式不支援特殊遊戲模式，因此總是會顯示 PGN 功能
2. **線上模式**：只有房主可以選擇遊戲模式，房客無法修改
3. **回放功能**：回放按鈕的顯示邏輯由 `updateReplayButtons()` 函數控制，與 PGN 按鈕保持一致

## 未來改進建議

1. 考慮為每種特殊模式添加專用的記錄格式（如擴展 PGN）
2. 允許使用者在設定中選擇是否強制啟用 PGN 記錄
3. 添加遊戲模式的說明文檔，解釋為什麼某些模式不支援 PGN

## 相關文件

- [遊戲模式文檔](docs/UPDATED_GAME_MODES.md)
- [PGN 功能文檔](docs/MOVE_LIST_PGN_FEATURE.md)
- [線上模式文檔](docs/ONLINE_MODE_FEATURE.md)
