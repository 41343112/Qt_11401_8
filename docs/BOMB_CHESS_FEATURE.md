# 踩地雷模式功能說明 (Bomb Chess Feature)

## 功能概述

踩地雷模式是一種刺激的西洋棋變體，在標準棋盤上隨機放置地雷。當棋子移動到有地雷的格子時會觸發爆炸，該棋子將被摧毀。如果是國王踩到地雷，遊戲立即結束，失去國王的一方輸掉比賽。

## 遊戲規則

### 基本規則
- 遊戲在標準 8x8 西洋棋盤上進行
- 所有標準西洋棋規則適用（將軍、將死、王車易位、吃過路兵、兵升變等）
- 踩地雷模式作為額外的元素疊加在標準規則之上

### 地雷配置
- **地雷數量**：每局遊戲隨機放置 4-5 個地雷
- **地雷區域**：第 3-6 行（索引 2-5）、第 a-h 列（索引 0-7）
- **隱藏性**：地雷在棋盤上不可見，玩家需要記憶或推測地雷位置
- **隨機性**：每次啟用踩地雷模式時，地雷位置都會重新隨機生成

### 地雷爆炸機制
1. **觸發條件**：任何棋子移動到有地雷的格子
2. **爆炸效果**：
   - 棋子立即從棋盤上移除
   - 該方的國王（旗子）也會被移除
   - 該地雷被消耗（移除）
   - 顯示爆炸動畫（橙紅色閃爍 1 秒）
   - 彈出爆炸通知訊息
   - 遊戲立即結束
3. **遊戲結束**：
   - 任何棋子踩到地雷，遊戲立即結束
   - 失去國王的一方（踩地雷方）輸掉比賽
   - 對手獲勝
   - 顯示爆炸訊息

### 遊戲結束條件
除了標準的將死和僵局外，踩地雷模式新增：
- **踩地雷爆炸**：任何一方的棋子踩到地雷，該方的國王（旗子）會被摧毀，遊戲立即結束，踩地雷方輸掉比賽

## 使用方式

### 啟用踩地雷模式

踩地雷模式僅在線上多人遊戲中可用：

1. **啟動遊戲**：點擊主選單的「線上遊玩」按鈕
2. **創建房間**：選擇「創建房間」選項
3. **選擇遊戲模式**：在遊戲模式選擇對話框中，勾選「💣 踩地雷」
4. **開始遊戲**：等待對手加入後，點擊「開始」按鈕

### 遊戲流程

1. **遊戲開始**：
   - 系統自動在指定區域隨機放置 4-5 個地雷
   - 地雷位置對雙方玩家不可見
   - 棋盤初始化完成，白棋先行

2. **正常走棋**：
   - 按照標準西洋棋規則移動棋子
   - 可以使用點擊、拖放或線上對手移動

3. **觸發地雷**：
   - 當棋子移動到地雷格子時：
     - 顯示爆炸動畫（橙紅色閃光）
     - 彈出爆炸訊息框
     - 棋子從棋盤上消失
     - 該方的國王（旗子）也會從棋盤上消失
     - 該地雷被移除
     - 遊戲立即結束
     - 對手獲勝

4. **遊戲結束**：
   - 任何棋子踩到地雷後，遊戲立即結束
   - 不會繼續進行

## 視覺反饋

### 爆炸效果
- **顏色**：爆炸的格子變為橙紅色（rgba(255, 100, 0, 0.8)）
- **邊框**：紅色邊框（3px solid #FF0000）
- **持續時間**：1 秒後恢復正常顏色

### 訊息通知
- **標題**：「💥 地雷爆炸！」
- **內容**：
  - 己方棋子：「💣 踩到地雷！棋子被炸毀了！國王也被摧毀！\n\n遊戲結束！」
  - 對手棋子：「💣 對手踩到地雷！棋子被炸毀了！對手的國王也被摧毀！\n\n遊戲結束！」

## 技術細節

### 資料結構
- `m_bombModeEnabled`：布林值，標記地雷模式是否啟用
- `m_minePositions`：`std::vector<QPoint>`，儲存所有地雷的位置
- `m_lastMoveTriggeredMine`：布林值，標記上一步是否觸發地雷

### 關鍵函數
- `enableBombMode(bool enable)`：啟用或停用地雷模式
- `placeMines()`：隨機放置地雷
- `isMineAt(const QPoint& pos)`：檢查指定位置是否有地雷
- `handleMineExplosion(const QPoint& logicalPosition, bool isOpponentMove)`：處理地雷爆炸效果

### 隨機數生成
使用 Qt 的 `QRandomGenerator::global()` 生成隨機數：
- 地雷數量：4 或 5 個（隨機）
- 地雷位置：使用 Fisher-Yates 洗牌算法隨機選擇

### 相容性
- **標準規則**：完全相容所有標準西洋棋規則
- **特殊走法**：王車易位、吃過路兵、兵升變均正常運作
- **將軍檢測**：國王爆炸後，將軍檢測仍然有效
- **輸入方式**：支援點擊、拖放和線上對手移動

## 策略提示

1. **避免地雷區域**：盡量避免將任何棋子移動到可能的地雷區域（第 3-6 行）
2. **謹慎移動**：每一步都可能是致命的，因為任何棋子踩到地雷都會導致遊戲立即結束
3. **記憶安全位置**：記住已安全移動過的位置，這些位置沒有地雷
4. **犧牲策略已無效**：不能再用小棋子來探測地雷，因為任何棋子踩雷都會輸掉比賽
5. **控制外圍**：優先控制棋盤外圍區域（第 1-2 行和第 7-8 行），這些區域沒有地雷
6. **強制對手冒險**：嘗試迫使對手移動到未知區域，增加對手踩雷的機會

## 注意事項

1. **僅限線上模式**：踩地雷模式僅在線上多人遊戲中可用
2. **隨機性**：每局遊戲的地雷位置都不同
3. **不可預測**：地雷位置完全隨機，無法預先知道
4. **一次性遊戲結束**：任何棋子踩到地雷，該方立即輸掉比賽，遊戲不會繼續
5. **相容性**：可以與其他遊戲模式組合使用

## 開發者資訊

### 檔案位置
- **核心邏輯**：`src/chessboard.cpp`、`src/chessboard.h`
- **UI 處理**：`src/qt_chess.cpp`、`src/qt_chess.h`
- **遊戲模式選擇**：`src/onlinedialog.cpp`、`src/onlinedialog.h`

### 測試建議
1. 測試地雷隨機生成是否在正確區域
2. 測試所有棋子類型的爆炸效果
3. 測試任何棋子踩到地雷是否正確移除國王並結束遊戲
4. 測試所有輸入方式（點擊、拖放、線上）
5. 測試與特殊走法的相容性（王車易位、吃過路兵、兵升變）
6. 測試線上同步是否正常
7. 測試國王是否被正確加入被吃掉的棋子列表

### 已知限制
- 地雷位置不會持久化，刷新或重連會失去地雷資訊
- 沒有「顯示地雷」的作弊模式
- 無法自訂地雷數量或位置

## 版本歷史

- **v1.0.0**（2024-12）：初始實現
  - 基本地雷功能
  - 隨機地雷放置
  - 爆炸效果
  - 國王爆炸結束遊戲
  - 支援所有輸入方式
