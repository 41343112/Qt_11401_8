# 霧戰模式功能總結

## 概述

本次更新為 Qt_Chess 添加了完整的霧戰（Fog of War）模式實現。在此模式下，玩家只能看到自己棋子及其可移動範圍內的視野，其餘位置顯示為霧狀效果。

## 主要變更

### 1. ChessBoard 類（chessboard.h / chessboard.cpp）

#### 新增方法
- `std::vector<QPoint> getVisibleSquaresForColor(PieceColor color) const`
  - 計算指定顏色玩家可見的所有方格
  - 包括該顏色所有棋子的位置
  - 包括所有棋子可以合法移動到的位置
  - 避免重複添加相同的方格

### 2. Qt_Chess 類（qt_chess.h / qt_chess.cpp）

#### 新增方法
- `bool isFogOfWarEnabled() const`
  - 檢查是否啟用霧戰模式
  
- `bool isSquareVisibleInFogOfWar(int logicalRow, int logicalCol, PieceColor viewingPlayer) const`
  - 檢查指定方格對於指定玩家是否可見
  
- `void displayPieceOnSquare(QPushButton* square, const ChessPiece& piece, bool isVisible)`
  - 重載方法，支持顯示霧狀效果

#### 修改方法
- `updateBoard()`
  - 添加霧戰模式檢查
  - 根據遊戲模式決定視角
  - 對每個方格應用可見性檢查
  
- `updateSquareColor(int displayRow, int displayCol)`
  - 為不可見的方格添加深灰色霧狀效果

### 3. 文檔

新增兩個文檔：
- `docs/FOG_OF_WAR_IMPLEMENTATION.md` - 詳細的實現說明
- `docs/FOG_OF_WAR_TEST_CASES.md` - 測試案例和驗證指南

## 視覺效果

### 可見方格
- 正常的棋盤顏色
- 顯示實際的棋子圖標或符號

### 不可見方格
- 深灰藍色背景 (RGB: 50, 50, 60)
- 顯示霧狀符號 🌫
- 灰色文字

## 遊戲邏輯

### 視角決定邏輯

**線上模式：**
- 房主視角 = 房主選擇的顏色
- 房客視角 = 房主選擇顏色的對立面
- 視角固定，不隨回合改變

**本地模式：**
- 視角 = 當前玩家顏色
- 視角隨回合切換

### 可見性規則

一個方格對於玩家可見，當且僅當：
1. 該方格上有玩家自己的棋子，或
2. 玩家的某個棋子可以合法移動到該方格

注意：
- "合法移動"是指該移動不會導致自己的國王被將軍
- 被對方棋子阻擋的遠程棋子（城堡、主教、皇后）無法看到障礙物後面的方格

## 性能考量

- 視野計算在每次 `updateBoard()` 時執行
- 對於每個玩家顏色，需要檢查該顏色所有棋子的所有可能移動
- 最壞情況下：16 個棋子 × 64 個目標方格 = 1024 次檢查
- 實際情況下，大部分移動會被快速排除
- 添加了重複方格檢查以避免浪費空間

## 兼容性

### 不受影響的模式
- 本地雙人對戰（未選擇霧戰）
- 電腦對弈
- 其他遊戲模式（地吸引力、傳送陣、骰子、踩地雷）

### 受影響的功能
- 僅在選擇「霧戰」模式時生效
- 主要用於線上對戰模式
- 也可在本地模式中使用（雖然兩人共用一個螢幕，視角會切換）

## 未來改進建議

1. **性能優化**
   - 緩存視野計算結果
   - 僅在棋子移動後重新計算視野
   
2. **視覺增強**
   - 添加漸變霧效果
   - 自訂霧的顏色和透明度
   - 添加霧的動畫效果

3. **功能擴展**
   - 在霧戰模式下隱藏被吃掉的棋子顯示
   - 添加「偵察」功能（消耗資源來臨時揭露一個區域）
   - 添加不同的視野規則（如只看到棋子攻擊範圍，不包括移動範圍）

4. **用戶體驗**
   - 添加教程說明霧戰模式的規則
   - 添加設定選項來調整霧戰效果
   - 提供視野範圍預覽

## 測試建議

請參考 `docs/FOG_OF_WAR_TEST_CASES.md` 中的詳細測試案例。

基本測試流程：
1. 創建線上房間並選擇霧戰模式
2. 驗證初始視野正確
3. 移動棋子後驗證視野更新
4. 在線上模式下用兩個客戶端測試雙方視角
5. 驗證未選擇霧戰時遊戲正常運行

## 代碼審查要點

1. **正確性**
   - ✅ 視野計算邏輯正確
   - ✅ 視角決定邏輯正確
   - ✅ 避免重複方格

2. **安全性**
   - ✅ 不會洩露對方的棋子位置
   - ✅ 遊戲規則仍然正確執行（將軍、將死等）
   
3. **性能**
   - ⚠️ 每次更新棋盤都重新計算視野（可以優化）
   - ✅ 複雜度可接受（O(pieces × squares)）

4. **兼容性**
   - ✅ 不影響其他遊戲模式
   - ✅ 向後兼容

## 總結

霧戰模式已經完整實現，提供了一種全新的遊戲體驗。玩家需要根據有限的視野來推測對方的棋子位置和策略，增加了遊戲的戰術深度和趣味性。
